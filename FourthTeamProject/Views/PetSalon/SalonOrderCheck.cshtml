@section  Styles{

    <style>
        .td-Width {
            width: 150px;
        }

        .card {
            margin-bottom: 10px;
        }

    </style>

}


<header class="bg-dark text-white py-3">
    <h2 class="text-center font-weight-bold">美容訂單確認</h2>
</header>

<div id="app" class="container mt-4">
    <div class="row">
        <div class="col-md-10">
            <table class="table" style="text-align:center">
                <thead>
                    <tr>
                        <th>美容服務</th>
                        <th>服務介紹</th>
                        <th>價格</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="SalonItem in SalonSolutionOrder" :key="SalonItem.salonSolutionName">
                        <template>
                            <td>{{SalonItem.salonSolutionName}}</td>
                            <td>{{SalonItem.salonSolutionDiscription}}</td>
                            <td>{{SalonItem.salonSolutionPrice}}</td>
                        </template>
                    </tr>
                </tbody>
            </table>
            <div class="mt-4">
                <h4>訂購人資料</h4>
                <div class="form-group">
                    <label for="name">姓名：</label>
                    <input type="text" class="form-control" id="name" name="name" v-model="member.name" required>
                </div>
                <div class="form-group">
                    <label for="phone">連絡電話：</label>
                    <input type="tel" class="form-control" id="phone" name="phone" v-model="member.phone" required>
                </div>
                <div class="form-group">
                    <label for="address">信箱：</label>
                    <input type="email" class="form-control" id="Email" name="Email" v-model="member.email" required>
                </div>
                <div class="form-group">
                    <label for="address">寵物名子：</label>
                    <input type="text" class="form-control" id="CatagoryName" name="CatagoryName" v-model="salonCatagoryName"  required>
                </div>
                <div class="form-group">
                    <label for="address">美容預約日期：</label>
                    <input type="date" v-model="orderDetailData" class="form-control custom-select" style="font-size:15px;" required>
                </div>
                <label for="phone">發票類型：</label>
                <div class="form-group" v-for="item in invoiceType">
                    <span></span>{{item.invoiceName}}
                    <input type="radio" name="invoice" v-model="invoice" :value="item.invoiceId" required>
                </div>
                <label for="phone">付款方式：</label>
                <div class="form-group" v-for="item in paymentType">
                    <span></span>{{item.payName}}
                    <input type="radio" name="payment" v-model="payment" :value="item.payId" required>
                </div>
                <button class="btn btn-primary btn-block" @@click="sendOrder">送出訂單</button>
            </div>
        </div>
    </div>

</div>




<script src="https://cdn.jsdelivr.net/npm/vue@2.7.14/dist/vue.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.2.2/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js" integrity="sha384-fbbOQedDUMZZ5KreZpsbe1LCZPVmfTnH7ois6mU1QK+m14rQ1l2bGBq41eYeM/fS" crossorigin="anonymous"></script>
<script>
    let app = new Vue({
        el: "#app",
        data: {
            member: [],
            SalonSolutionOrder: [],
            invoiceType: [],
            paymentType: [],
            salonCatagoryName: "",
            orderDetailData: "",
            invoice: "",
            payment: "",
            addForm: {
                MerchantID: '@ViewData["MerchantID"]'
                , MerchantOrderNo: '@ViewData["MerchantOrderNo"]'
                , ExpireDate: '@ViewData["ExpireDate"]'
                , ReturnURL: '@ViewData["ReturnURL"]'
                , CustomerURL: '@ViewData["CustomerURL"]'
                , NotifyURL: '@ViewData["NotifyURL"]'
                , ClientBackURL: '@ViewData["ClientBackURL"]'
            },
        },
        mounted() {
            let _this = this;
            const urlParams = new URLSearchParams(window.location.search);
            const urlmemberdata = urlParams.get("member");
            const urlorderdata = urlParams.get("orderData");
            const memberdata = JSON.parse(decodeURIComponent(urlmemberdata));
            const orderdata = JSON.parse(decodeURIComponent(urlorderdata));
            console.log(memberdata);
            console.log(orderdata);
            _this.member = memberdata;
            _this.SalonSolutionOrder = orderdata;
            axios.post('/api/PetProdcutAPI/getInvoice').then(response => _this.invoiceType = response.data);
            axios.post('/api/PetProdcutAPI/getPayment').then(response => _this.paymentType = response.data);
        },
        //computed: {
        //    currentDate() {
        //        const today = new Date();
        //        const year = today.getFullYear();
        //        const month = String(today.getMonth() + 1).padStart(2, '0');
        //        const day = String(today.getDate()).padStart(2, '0');
        //        return `${year}-${month}-${day}`;
        //    }
        //},
        methods: {
            sendOrder: function () {
                let _this = this;
                // 組合表單資料
                var postData = {};
                postData['MerchantID'] = _this.addForm.MerchantID;
                postData['MerchantOrderNo'] = _this.addForm.MerchantOrderNo;
                postData['ItemDesc'] = _this.member.name + '-' + _this.SalonSolutionOrder[0].salonSolutionName;//付款人資訊。
                postData['Amt'] = _this.SalonSolutionOrder[0].salonSolutionPrice;//結帳金額
                postData['ExpireDate'] = _this.addForm.ExpireDate;
                postData['ReturnURL'] = _this.addForm.ReturnURL;
                postData['CustomerURL'] = _this.addForm.CustomerURL;
                postData['NotifyURL'] = _this.addForm.NotifyURL;
                postData['ClientBackURL'] = _this.addForm.ClientBackURL;
                postData['Email'] = _this.member.email;
                // 使用 jQuery Ajax 傳送至後端
                $.ajax({
                    url: '@Url.Content("~/Product/SendToNewebPay")',
                    method: 'POST',
                    dataType: 'json',
                    data: { inModel: postData, __RequestVerificationToken: $('@Html.AntiForgeryToken()').val() },
                    success: function (returnObj) {
                        // 呼叫藍新金流 API
                        const form = document.createElement('form');
                        form.method = 'post';
                        form.action = 'https://ccore.newebpay.com/MPG/mpg_gateway';//藍新金流驗證網址(測試環境)

                        for (const key in returnObj) {
                            if (returnObj.hasOwnProperty(key)) {
                                //將回傳的Json物件開頭轉為大寫
                                const fixedKey = key.charAt(0).toUpperCase() + key.slice(1);
                                const hiddenField = document.createElement('input');
                                hiddenField.type = 'hidden';
                                hiddenField.name = fixedKey;
                                hiddenField.value = returnObj[key];
                                form.appendChild(hiddenField);
                            }
                        }
                        var order = {
                            SalonOrderID: 0,
                            MemberId: _this.member.id,
                            PayId: _this.payment,
                            InvoiceId: _this.invoice,
                            OrderMemberName: _this.member.name,
                            OrderMemberPhone: _this.member.phone,
                            OrderMemberEmail: _this.member.email,
                        };
                        var Detail = {
                            SalonOrderDetailId: 0,
                            Appointment: _this.orderDetailData,
                            UnitPrice: _this.SalonSolutionOrder[0].salonSolutionPrice,
                            SalonCatagoryName: _this.salonCatagoryName,
                            SalonSolutionName: _this.SalonSolutionOrder[0].salonSolutionName,
                        };
                        axios.post(`/api/SalonClient/Getorder`, order);
                        axios.post(`/api/SalonClient/GetorderDetail`, Detail);
                        document.body.appendChild(form);
                        form.submit();
                    },
                    error: function (err) {
                        alert(err.status + " " + err.statusText + '\n' + err.responseText);
                    }
                })
            },

        }
    });
</script>

